$(document).ready(function(){
  setUp();
  get_month_events();

//********* Page **********************

  $('#year').click(function(){
    calendar();
    get_month_events();
  });

  $('#month').click(function(){
    calendar();
    get_month_events();
  });

  $('.active_cell').live('click', function(){
    var cur_date = document.getElementById('year').value + '-' + 
                    (document.getElementById('month').selectedIndex + 1) +
                    '-' + $(this).html();
    $('.events_list').css('display', 'block');
    $('#cur_date').val(cur_date);
    update_events_list();
  });

  $('#my_events').click(function(){
    $.get(
      '/my_events',
      function(data){
        $('#all_events_content').html('');
        $('#all_events_content').append(data);
      },
      'html'
    );
    $('.all_events_name').html('My events');
    $('.all_events').css('display', 'block');
  });

  $('#all_events').click(function(){
    $.get(
      '/share_events',
      function(data){
        $('#all_events_content').html('');
        $('#all_events_content').append(data);
      },
     'html'
    );
    $('.all_events_name').html('All events');
    $('.all_events').css('display', 'block');
  });

  $('#user_submit').live('click',function(){
    $('#u_form').ajaxForm(function(){
    });
  });

//********* All events form ******

  $('#all_events_close').click(function(){
    $('.all_events').css('display', 'none');
  });
  
  $('.all_events_title').live('click', function(){
    $.get(
      $(this).attr('tag'),
      function(data){
        $('.show_event_form').html('');
        $('.show_event_form').append(data);
      },
      'html'
    );
    $('.show_event').css('display', 'block');
  });

//********* Events list form **********

  $('#events_list_add').live('click', function(){
    $('.event').css('display', 'block');
    $.get(
      $(this).attr('tag'),
      function(data){
        $('.event_form').html('');
        $('.event_form').append(data);
        $('#event_point_date').val($('#cur_date').val());
      },
      'html'
    );
  });

  $('#events_list_close').click(function(){
    $('.events_list').css('display', 'none');
  });

  $('.events_list_del').live('click', function(){
    $.post(
      $(this).attr('tag'),
      {_method:'delete', authenticity_token:$('#authenticity_token').val()},
      function(){
        get_month_events();
        update_events_list();
      }
    );
  });

  $('.events_list_title').live('click', function(){
    $('.event').css('display', 'block');
    $.get(
      $(this).attr('tag'),
      function(data){
        $('.event_form').html('');
        $('.event_form').append(data);
        if ($('.event_div_cycle > input[type="radio"]').is(':checked')){
          $('#event_is_cycle').attr('checked','');
          $('.event_div_cycle > input[type="radio"]').removeAttr('disabled');
        }else{
          $('.event_div_cycle > input[type="radio"]').attr('disabled','');
        }
      },
      'html'
    );
  });

//********* Event form ****************

  $('.event_close').live('click', function(){
    $('.event').css('display', 'none');
  });

  $('#event_is_cycle').live('change', function(){
    if ($(this).is(':checked')){
      $('.event_cycle').removeAttr('disabled');
    }else{
      $('.event_cycle').attr('disabled', '');
    }
  });

  $('#event_submit').live('click', function(){
    $('#e_form').ajaxForm(function(data){
      if (data != '') {
        alert(data);
      }else{
        get_month_events();
        update_events_list();
      }
    });
    $('.event').css('display', 'none');
  });

//********* Show event form ***********

  $('#show_event_close').live('click', function(){
    $('.show_event').css('display', 'none');
  });

});
//********* Non-events functions ******

function update_events_list(){
  $.get(
    '/day_events',
    {date:$('#cur_date').val()},
    function(data){
      $('#events_list_content').html('');
      $('#events_list_content').append(data);
    },
    'html'
  );
}

function get_month_events(){
  $('.active_cell').attr('title', 'counts: 0');
  $.getJSON(
    '/month_events.json',
    {month:(document.getElementById('month').selectedIndex + 1),
                    year:document.getElementById('year').value},
    function(json){
      $.each(json, function(i){
        $('#cell-' + json[i]['day']).attr('title','counts: ' +
                                          json[i]['count']);
      });
    }
  );
}
